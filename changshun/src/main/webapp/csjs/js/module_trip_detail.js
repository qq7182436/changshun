define("tour_amd/module_trip_detail",["jquery","tour_amd/tool_tip","layer"],function($){var TripDetail=function(cfg){this.WIN_TOP=54;this.cfg=cfg;this.init();this.bindEvents();}
TripDetail.prototype={init:function(){$.extend(this,this.cfg);this.dayNav=this.elt.find(".J_day_nav");this.dayList=this.elt.find(".J_day_list");},bindEvents:function(){$(document).scroll($.proxy(this.onDocumentScroll,this));$(window).resize($.proxy(this.onWindowResize,this));this.dayNav.on("click","li",$.proxy(this.onNavItemClick,this));this.dayList.find(".section_images img").mouseover($.proxy(this.onSectionImgMouseover,this)).mouseout($.proxy(this.onSectionImgMouseout,this));this.dayList.find(".section_title").on("click",$.proxy(this.onSectionTitleClick,this));},onDocumentScroll:function(){var self=this;if(this.scrollTimer){clearTimeout(this.scrollTimer);this.scrollTimer=null;}
this.scrollTimer=setTimeout(function(){self.update();self.scrollTimer=null;},20);},onWindowResize:function(){var self=this;var scrollLeft=$(window).scrollLeft(),listOffset=this.dayList.offset(),navOffset=this.dayNav.offset();this.dayNav.attr("style","");$("html body").trigger("scroll");},onSectionImgMouseover:function(e){toolTip('<img style="width: 490px;" src='+$(e.target).attr("data-picurl")+'>');},onSectionImgMouseout:function(e){toolTip();},onSectionTitleClick:function(e){var spotid=$(e.target).attr("data-spotid");if(spotid){var promise=this.querySpotInfo(spotid);promise.then(function(data){if(data){var i=$.layer({type:1,shadeClose:true,fix:false,title:data.spotDetailHTMLTitle,border:[6,0.3,'#000'],area:['804px','420px'],page:{html:data.spotDetailHTMLBody},success:function(page){$(page).addClass("layer_spot");$(page).find(".gy-gallery").gyGallery({"width":490,"height":275});}});}});}},querySpotInfo:function(id){var promise=$.ajax({url:"/yii.php?r=detail/tourAjax/getSpotDetail",dataType:"jsonp",jsonp:"callback",data:{spotid:id}});return promise;},onNavItemClick:function(e){this.slideToDay($(e.target).index());},slideToDay:function(index){var self=this,day=this.dayList.find(".trip_day").eq(index);$("html,body").animate({scrollTop:day.offset().top-self.WIN_TOP},500);},update:function(){var scrollTop=$(window).scrollTop(),scrollLeft=$(window).scrollLeft(),listOffset=$(this.dayList).offset(),listHeight=$(this.dayList).height(),navOffset=this.dayNav.offset(),navHeight=this.dayNav.height();if(scrollTop+this.WIN_TOP<listOffset.top){this.dayNav.attr("style","");}else if(scrollTop+this.WIN_TOP<listOffset.top+listHeight-navHeight){this.dayNav.attr("style","");this.dayNav.css({position:"fixed",top:this.WIN_TOP,left:navOffset.left-scrollLeft});}else if(scrollTop+this.WIN_TOP<listOffset.top+listHeight){this.dayNav.attr("style","");this.dayNav.css({position:"absolute",top:"auto",bottom:0});}else{this.dayNav.attr("style","");}
var days=this.dayList.find(".trip_day");for(var i=days.length-1;i>=0;i--){if((scrollTop+this.WIN_TOP)>=$(days[i]).offset().top){this.dayNav.find("li").removeClass("cur");this.dayNav.find("li").eq(i).addClass("cur");break;}}}}
return TripDetail;});